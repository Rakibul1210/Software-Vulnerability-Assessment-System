import json
import csv
import pandas as pd

class Converter:

    def __init__(self, file_name):
        self.file_name = file_name

    def convert_to_csv(self):

        print("in converter: ",self.file_name)
        # Read JSON data from file
        with open('Data/json/' + self.file_name + '.json') as json_file:
            data = json.load(json_file)

        # Write data to csv file
        with open('Data/csv/' + self.file_name + '.csv', 'w', newline='') as file:
            csv_writer = csv.writer(file)

            csv_writer.writerow(['CVE_ID', 'description', 'Version', 'attackVector', 'attackComplexity', 'privilegesRequired',
                                 'userInteraction',
                                 'scope', 'confidentialityImpact', 'integrityImpact', 'availabilityImpact', 'vectorString',
                                 'exploitabilityScore', 'impactScore', 'baseScore'])

            cve_items = data['CVE_Items']
            for item in cve_items:
                id = item['cve']['CVE_data_meta']['ID']
                description = item['cve']['description']['description_data'][0]['value']

                impact = item.get('impact', {})
                if impact:
                    av = item['impact']['baseMetricV3']['cvssV3']['attackVector']
                    ac = item['impact']['baseMetricV3']['cvssV3']['attackComplexity']
                    pr = item['impact']['baseMetricV3']['cvssV3']['privilegesRequired']
                    ui = item['impact']['baseMetricV3']['cvssV3']['userInteraction']
                    sc = item['impact']['baseMetricV3']['cvssV3']['scope']
                    ci = item['impact']['baseMetricV3']['cvssV3']['confidentialityImpact']
                    ii = item['impact']['baseMetricV3']['cvssV3']['integrityImpact']
                    ai = item['impact']['baseMetricV3']['cvssV3']['availabilityImpact']
                    baseScore = item['impact']['baseMetricV3']['cvssV3']['baseScore']
                    baseSeverity = item['impact']['baseMetricV3']['cvssV3']['baseSeverity']
                    exploitabilityScore = item['impact']['baseMetricV3']['exploitabilityScore']
                    impactScore = item['impact']['baseMetricV3']['impactScore']

                    vectorString = item['impact']['baseMetricV3']['cvssV3']['vectorString']
                    version = item['impact']['baseMetricV3']['cvssV3']['version']
                else:
                    version = '0'
                    av = ac = pr = ui = sc = ci = ii = ai = baseScore = baseSeverity = exploitabilityScore = impactScore = vectorString = None

                csv_writer.writerow(
                    [id, description, version, av, ac, pr, ui, sc, ci, ii, ai, vectorString, exploitabilityScore, impactScore,
                     baseScore])

                print(id)

                if id == 'CVE-2016-0400':
                    break

        print("Data saved as CSV!!")
        print("Goodbye, world!!")


if __name__ == '__main__':
    file_name = 'small_data'
    c = Converter(file_name)
    c.convert_to_csv()


    data = pd.read_csv('Data/csv/' + file_name + '.csv', encoding='latin1').dropna()

    print(data)



